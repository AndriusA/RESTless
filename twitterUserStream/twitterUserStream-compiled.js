$(function(){function d(a){_.each(a,function(b,e){_.isNull(b)||_.isEmpty(b)&&!_.isNumber(b)&&!_.isBoolean(b)?delete a[e]:_.isObject(b)&&(a[e]=d(b))});return a}tweetsModel=new function(){function a(a){return _.has(a,"retweeted")}var b=_.partial(function(a,b){return _.omit(b,a)},"id source truncated filter_level lang possibly_sensitive".split(" ")),e=_.compose(d,b,function(a){var b=_.clone(a);_.has(a,"user")&&_.has(a.user,"id_str")&&(b.user_id_str=a.user.id_str,b.user=null);return b},_.clone);this.twitterEvents=
new Bacon.Bus;this.deletedTweets=new Bacon.Bus;this.onlyTweets=this.twitterEvents.filter(a);this.tweets=this.twitterEvents.filter(a).map(e).map(function(a){var b=_.clone(a);_.has(a,"retweeted_status")&&(b.retweeted_status.user_id_str=a.retweeted_status.id_str,b.retweeted_status.user=null,b.retweeted_status=e(a.retweeted_status));return b});this.deletedTweets.plug(this.twitterEvents.filter(function(a){return _.has(a,"delete")&&_.has(a["delete"],"status")}));tweetChanges=this.tweets.map(function(a){return function(b){return b.concat([a])}}).merge(this.deletedTweets.map(function(a){return function(b){return _.reject(b,
function(b){return b.id_str===a.delete.status.id_str})}}));this.allTweets=tweetChanges.scan([],function(a,b){return b(a)})};usersModel=new function(){this.twitterEvents=new Bacon.Bus;this.tweets=new Bacon.Bus;this.retrieveItem=function(a){return function(b){return _.find(b,function(b){return b.id_str==a})}};retweetUserInfo=this.tweets.flatMap(function(a){return a.hasOwnProperty("retweeted_status")?Bacon.once(_.clone(a.retweeted_status.user)):Bacon.never()});tweetUserInfo=this.tweets.map(function(a){return _.clone(a.user)});
events=this.twitterEvents.filter(function(a){return _.has(a,"event")});followUserInfo=events.filter(function(a){return _.where([a],{event:"follow"})}).map(function(a){return _.clone(a.target)});this.userInfo=Bacon.mergeAll([followUserInfo,tweetUserInfo,retweetUserInfo]).map(function(a){return function(b){return _.reject(b,function(b){return b.id_str===a.id_str}).concat([a])}});this.allUsers=this.userInfo.scan([],function(a,b){return b(a)})};var c=Bacon.UI.hash("#/"),f=$("#filters");c.onValue(function(a){f.find("a").each(function(){var b=
$(this);b.toggleClass("selected",b.attr("href")==a)})});var h=c.decode({"#/":tweetsModel.allTweets,"#/users":usersModel.allUsers}),k=$("#tweet-count");h.onValue(function(a){Bacon.once(a).map(".length").map(function(a){return"<strong>"+a+"</strong>"+(1==a?" item":" items")}).assign(k,"html")});c.onValue(function(a){console.log(a);if("#/"===a){var b=$("#tweet-list");a=tweetsModel;var e=usersModel,c=function(a){get=e.retrieveItem(a.user_id_str);var c=e.allUsers.map(get).skipDuplicates(),d=Handlebars.compile($("#tweet-template").html());
a=$(d(_.extend(a,{user:c})));var g=a.find(".tweetHeader"),d=g.find(".userName"),g=g.find(".userHandle"),f=a.find(".tweetImage img");userName=c.map(function(a){if(_.has(a,"name"))return a.name});userHandle=c.map(function(a){if(_.has(a,"screen_name"))return a.screen_name});tweetImage=c.map(function(a){if(_.has(a,"profile_image_url"))return a.profile_image_url});tweetImage.log("image");userName.assign(d,"text");userHandle.assign(g,"text");tweetImage.assign(f,"attr","src");b.prepend(a)};a.deletedTweets.merge(Bacon.once()).map(h).onValue(function(a){b.children().remove();
_.each(a,c)});a.tweets.onValue(function(a){c(a)})}else if("#/users"===a){var d=$("#tweet-list");a=usersModel;var j=function(a){d.children().remove();_.each(a,f)},f=function(a){var b=Handlebars.compile($("#user-template").html());a=$(b(a));d.prepend(a)};Bacon.once().merge(Bacon.once()).map(h).map(j);a.allUsers.onValue(function(a){j(a)})}});c=new WebSocket("ws://127.0.0.1:6969");c.onopen=function(){console.log("Websocket connection opened")};tweetsModel.twitterEvents.plug(Bacon.fromEventTarget(c,"message").map(".data").map(JSON.parse));
usersModel.twitterEvents.plug(tweetsModel.twitterEvents);usersModel.tweets.plug(tweetsModel.onlyTweets);tweetsModel.allTweets.map(function(a){return!_.isEmpty(a)}).assign($("#main,#footer"),"toggle")});